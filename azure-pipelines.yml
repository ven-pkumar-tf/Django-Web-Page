trigger:
  - main  # Trigger the pipeline on changes to the main branch

pool:
  vmImage: 'ubuntu-latest'  # Use the latest Ubuntu image

jobs:
  - job: Build
    displayName: 'Build Python App'
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.12'
          addToPath: true

      - script: |
          python -m venv venv
          source venv/bin/activate
        displayName: 'Create and activate virtual environment'

      - script: |
          pip install -r requirements.txt
        displayName: 'Install dependencies'

      - script: |
          zip release.zip ./* -r -x "venv/*"
        displayName: 'Zip artifact for deployment'

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'release.zip'
          ArtifactName: 'python-app'
          publishLocation: 'Container'

  - job: Deploy
    displayName: 'Deploy to Azure Web App'
    dependsOn: Build
    steps:
      - task: DownloadBuildArtifacts@0
        inputs:
          artifactName: 'python-app'
          downloadPath: '$(Build.ArtifactStagingDirectory)'

      - task: AzureCLI@2
        displayName: 'Login to Azure'
        inputs:
          azureSubscription: 'aks-service-connection'  # Replace with your Azure service connection
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
            az login --service-principal -u ${{ secrets.__clientidsecretname__ }} -p ${{ secrets.__tenantidsecretname__ }} --tenant ${{ secrets.__subscriptionidsecretname__ }}

      - task: AzureWebApp@1
        displayName: 'Deploy to Azure Web App'
        inputs:
          ConnectionType: 'AzureRM'
          azureSubscription: 'aks-service-connection'  # Replace with your Azure service connection
          appType: 'webAppLinux'
          WebAppName: 'tamil-web-page-service'  # Replace with your Azure Web App name
          packageForLinux: '/home/vsts/work/1/a/python-app/release.zip'
          RuntimeStack: 'PYTHON|3.12'  # Ensure the correct runtime stack is set for your app
          
